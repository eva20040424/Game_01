:: widget_Library [widget]

/* === æ ¸å¿ƒï¼šJavascript è™•ç†å€ (æ”¯æ´é…’é¤¨è¤‡é›œé è¨­) === */
<<script>>
    /* 1. æª”æ¡ˆåŒ¯å…¥è™•ç† */
    window.loadTavernFile = function(input, type) {
        if (!input.files || !input.files[0]) return;
        var file = input.files[0];
        var reader = new FileReader();

        reader.onload = function(e) {
            var content = e.target.result;
            try {
                var data = JSON.parse(content);
                // å…¼å®¹ V2
                if (data.spec === 'chara_card_v2' && data.data) data = data.data;

                var name = data.name || (file.name.replace(/\.[^/.]+$/, "")) || "æœªå‘½å"; 

                // === A. è§’è‰²æ›¸ ===
                if (type === 'char') {
                    var formattedText = "ã€è§’è‰²åç¨±ã€‘ï¼š" + name + "\n";
                    if (data.entries) { 
                        formattedText += "ã€è©³ç´°è¨­å®šé›†æˆã€‘ (Source: Lorebook):\n";
                        Object.values(data.entries).forEach(entry => {
                            if(entry.content && entry.enabled !== false) {
                                var keys = (entry.key || []).join(', ');
                                if (keys.includes("æ¬Šèƒ½") || keys.includes("å¤©è³¦") || keys.includes("é–å®š")) {
                                    formattedText += "ğŸ”´ [IMPORTANT]: " + keys + "\n";
                                } else {
                                    formattedText += "--- [" + keys + "] ---\n";
                                }
                                formattedText += entry.content + "\n\n";
                            }
                        });
                    } else {
                        if(data.description) formattedText += "ã€æè¿°ã€‘ï¼š" + data.description + "\n";
                        if(data.personality) formattedText += "ã€æ€§æ ¼ã€‘ï¼š" + data.personality + "\n";
                        if(data.first_mes) formattedText += "ã€é–‹å ´ç™½ã€‘ï¼š" + data.first_mes + "\n";
                    }
                    State.variables.custom_chars[name] = formattedText;
                    if(!State.variables.active_char_ids.includes(name)) State.variables.active_char_ids.push(name);
                    memorize("custom_chars", State.variables.custom_chars);
                } 
                // === B. ä¸–ç•Œæ›¸ ===
                else if (type === 'lore') {
                    var formattedText = "ã€ä¸–ç•Œè§€ã€‘ï¼š" + name + "\n";
                    if (data.entries) {
                        Object.values(data.entries).forEach(entry => {
                            if(entry.content && entry.enabled !== false) {
                                var keys = (entry.key || []).join(', ');
                                formattedText += "=== " + keys + " ===\n";
                                formattedText += entry.content + "\n\n";
                            }
                        });
                    } else {
                        formattedText += JSON.stringify(data, null, 2);
                    }
                    State.variables.custom_lore[name] = formattedText;
                    if(!State.variables.active_world_ids.includes(name)) State.variables.active_world_ids.push(name);
                    memorize("custom_lore", State.variables.custom_lore);
                }
                // === C. é¢¨æ ¼é è¨­ (å¤§å‡ç´šï¼) ===
                else if (type === 'preset') {
                    // æª¢æŸ¥æ˜¯å¦ç‚ºé…’é¤¨çš„è¤‡é›œæ ¼å¼ (å«æœ‰ prompts é™£åˆ—)
                    if (data.prompts && Array.isArray(data.prompts)) {
                        // ç›´æ¥å­˜å„²æ•´å€‹çµæ§‹ï¼Œè€Œä¸æ˜¯è½‰æˆå­—ä¸²
                        State.variables.custom_presets[name] = {
                            type: "advanced",
                            data: data.prompts
                        };
                    } else {
                        // èˆŠçš„ç°¡å–®æ ¼å¼ (æˆ–è€…åªæ˜¯å–®ç´”çš„å­—ä¸²)
                        var text = data.system_prompt || data.prompt || data.content || data.data || "";
                        State.variables.custom_presets[name] = {
                            type: "simple",
                            data: text
                        };
                    }
                    
                    // åˆ‡æ›åˆ°æ–°é è¨­
                    State.variables.active_preset_id = name;
                    memorize("custom_presets", State.variables.custom_presets);
                    memorize("active_preset_id", name);
                }
                
                // åŒ¯å…¥å¾Œåˆ·æ–°
                new Wikifier(null, '<<replace "#lib-content">><<if $lib_tab is "char">><<lib_content_char>><<elseif $lib_tab is "lore">><<lib_content_lore>><<else>><<lib_content_preset>><</if>><</replace>>');
                alert("ğŸ“š åŒ¯å…¥ä¸¦å„²å­˜æˆåŠŸï¼š " + name);

            } catch (err) {
                console.error(err);
                alert("âŒ æ ¼å¼éŒ¯èª¤ï¼šç„¡æ³•è§£æé€™å€‹ JSON æª”æ¡ˆã€‚");
            }
        };
        reader.readAsText(file);
    };

    /* 2. è™•ç†è¤‡é¸æ¡† (é™£åˆ—) */
    window.toggleLibItem = function(listName, item) {
        var list = State.variables[listName];
        if(!Array.isArray(list)) list = [];
        var idx = list.indexOf(item);
        if(idx > -1) list.splice(idx, 1);
        else list.push(item);
    };
    
    /* 3. è™•ç†å–®é¸æ¡† (é¢¨æ ¼é è¨­) */
    window.selectPreset = function(id) {
        State.variables.active_preset_id = id;
        memorize("active_preset_id", id);
        // åˆ·æ–°é¡¯ç¤ºä»¥æ›´æ–°ä¸‹æ–¹çš„é–‹é—œåˆ—è¡¨
        new Wikifier(null, '<<replace "#preset-details">><<preset_details_panel>><</replace>>');
    };

    /* 4. è™•ç†é…’é¤¨é è¨­å…§éƒ¨çš„é–‹é—œ (Toggle Sub-prompts) */
    window.togglePresetBlock = function(presetId, blockIndex) {
        var preset = State.variables.custom_presets[presetId];
        if (preset && preset.type === 'advanced') {
            // åˆ‡æ› enabled ç‹€æ…‹
            preset.data[blockIndex].enabled = !preset.data[blockIndex].enabled;
            // å­˜æª”
            memorize("custom_presets", State.variables.custom_presets);
        }
    };

    /* 5. åˆªé™¤é …ç›® */
    window.deleteLibItem = function(type, key) {
        if(confirm("ç¢ºå®šè¦åˆªé™¤ã€Œ" + key + "ã€å—ï¼Ÿ")) {
            if(type === 'char') {
                delete State.variables.custom_chars[key];
                var idx = State.variables.active_char_ids.indexOf(key);
                if(idx > -1) State.variables.active_char_ids.splice(idx, 1);
                memorize("custom_chars", State.variables.custom_chars);
                new Wikifier(null, '<<replace "#lib-content">><<lib_content_char>><</replace>>');
            } else if (type === 'lore') {
                delete State.variables.custom_lore[key];
                var idx = State.variables.active_world_ids.indexOf(key);
                if(idx > -1) State.variables.active_world_ids.splice(idx, 1);
                memorize("custom_lore", State.variables.custom_lore);
                new Wikifier(null, '<<replace "#lib-content">><<lib_content_lore>><</replace>>');
            } else if (type === 'preset') {
                delete State.variables.custom_presets[key];
                if(State.variables.active_preset_id === key) {
                    State.variables.active_preset_id = "ç³»çµ±åŸå» ";
                    memorize("active_preset_id", "ç³»çµ±åŸå» ");
                }
                memorize("custom_presets", State.variables.custom_presets);
                new Wikifier(null, '<<replace "#lib-content">><<lib_content_preset>><</replace>>');
            }
        }
    };
<</script>>

/* === ä»‹é¢ï¼šæ›¸ç±é¸å–®å¤–æ¡† === */
<<widget "library_panel">>
    <div class="library-box" style="border: 1px solid #555; padding: 10px; margin-top: 10px; border-radius: 5px; background: rgba(0,0,0,0.3);">
        
        /* é ç±¤åˆ‡æ› */
        <<if ndef $lib_tab>><<set $lib_tab to 'preset'>><</if>>
        
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9em;">
            <<button "ğŸ“ é è¨­">> <<set $lib_tab to 'preset'>> <<replace "#lib-content">><<lib_content_preset>><</replace>> <</button>>
            <<button "ğŸ‘¤ è§’è‰²">> <<set $lib_tab to 'char'>> <<replace "#lib-content">><<lib_content_char>><</replace>> <</button>>
            <<button "ğŸŒ ä¸–ç•Œ">> <<set $lib_tab to 'lore'>> <<replace "#lib-content">><<lib_content_lore>><</replace>> <</button>>
        </div>

        <div id="lib-content">
            <<if $lib_tab is 'char'>>
                <<lib_content_char>>
            <<elseif $lib_tab is 'lore'>>
                <<lib_content_lore>>
            <<else>>
                <<lib_content_preset>>
            <</if>>
        </div>
        
    </div>
<</widget>>

/* === å…§å®¹ï¼šé¢¨æ ¼é è¨­ (å«é–‹é—œé¢æ¿) === */
<<widget "lib_content_preset">>
    <div style="font-size: 0.9em;">
        <b>ğŸ“¥ åŒ¯å…¥é è¨­ (JSON):</b><br>
        <input type="file" onchange="loadTavernFile(this, 'preset')" style="width: 100%; font-size: 0.8em;">
        <hr style="margin: 5px 0; border-color: #444;">
        
        <b>ğŸŸ¢ é¸æ“‡é è¨­:</b>
        <div style="max-height: 100px; overflow-y: auto; text-align: left; border-bottom: 1px solid #444; margin-bottom: 5px;">
            /* 1. ç³»çµ±åŸå»  */
            <div style="margin-bottom: 5px;">
                <label>
                    <input type="radio" name="preset_select" 
                           @checked="$active_preset_id === 'ç³»çµ±åŸå» '"
                           onclick="selectPreset('ç³»çµ±åŸå» ')" />
                    <span style="color: #ff99cc; font-weight:bold;">ğŸ”’ ç³»çµ±åŸå» </span>
                </label>
            </div>
            /* 2. ç©å®¶è‡ªå®šç¾© */
            <<for _key range Object.keys($custom_presets)>>
                 <<capture _key>>
                    <div style="margin-bottom: 2px; display:flex; align-items:center; justify-content:space-between;">
                        <label>
                            <input type="radio" name="preset_select"
                                   @checked="$active_preset_id === _key" 
                                   @onclick="'selectPreset(\'' + _key + '\')'" />
                            <span style="color: #66ccff;">ğŸ’¾ _key</span>
                        </label>
                        <a class="delete-btn" @onclick="'deleteLibItem(\'preset\', \'' + _key + '\')'">ğŸ—‘ï¸</a>
                    </div>
                 <</capture>>
            <</for>>
        </div>
        
        /* å‹•æ…‹é¡¯ç¤ºè©³ç´°é–‹é—œé¢æ¿ */
        <div id="preset-details">
            <<preset_details_panel>>
        </div>

    </div>
<</widget>>

/* === å­çµ„ä»¶ï¼šé è¨­è©³æƒ…é–‹é—œ === */
<<widget "preset_details_panel">>
    <<set _currentId to $active_preset_id>>
    <<set _presetData to $custom_presets[_currentId]>>
    
    <<if _presetData && _presetData.type === 'advanced'>>
        <div style="background: rgba(0,0,0,0.2); padding: 5px; border-radius: 3px;">
            <div style="font-size:0.8em; color:#aaa; margin-bottom:5px;">ğŸ›ï¸ <b>è©³ç´°æ¨¡çµ„æ§åˆ¶</b> (å³æ™‚ç”Ÿæ•ˆ):</div>
            <div style="max-height: 200px; overflow-y: auto;">
                <<for _i, _block range _presetData.data>>
                    <<capture _currentId, _i>>
                        <div style="margin-bottom: 3px; border-left: 2px solid #555; padding-left: 5px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" 
                                       @checked="_block.enabled" 
                                       @onchange="'togglePresetBlock(\'' + _currentId + '\', ' + _i + ')'" />
                                <span style="font-size: 0.8em; margin-left: 5px; color: #ddd;">
                                    <<print _block.name || ("æ¨¡çµ„ " + (_i+1))>>
                                </span>
                            </label>
                            /* å¦‚æœæœ‰å…§å®¹é è¦½ï¼Œå¯ä»¥æ–Ÿé…Œé¡¯ç¤ºï¼Œé€™è£¡åªé¡¯ç¤ºæ¨™é¡Œ */
                        </div>
                    <</capture>>
                <</for>>
            </div>
        </div>
    <<elseif _currentId === 'ç³»çµ±åŸå» '>>
        <div style="font-size:0.8em; color:#888; padding:5px;">
            (ä½¿ç”¨å…§å»ºè¨­å®šï¼Œç„¡å¯èª¿æ•´é¸é …)
        </div>
    <</if>>
<</widget>>

/* === å…§å®¹ï¼šè§’è‰²èˆ‡ä¸–ç•Œ (ä¿æŒåŸæ¨£) === */
<<widget "lib_content_char">>
    /* ... (ä¿æŒä¸Šæ¬¡çš„å…§å®¹) ... */
    <div style="font-size: 0.9em;"><b>ğŸ“¥ åŒ¯å…¥è§’è‰²:</b><br><input type="file" onchange="loadTavernFile(this, 'char')" style="width: 100%; font-size: 0.8em;"><hr style="margin: 5px 0; border-color: #444;"><b>ğŸ“‹ å•Ÿç”¨åˆ—è¡¨:</b><div style="max-height: 150px; overflow-y: auto; text-align: left;"><<for _key range Object.keys(setup.chars)>><<capture _key>><div style="margin-bottom: 2px;"><label><input type="checkbox" @checked="$active_char_ids.includes(_key)" @onchange="'toggleLibItem(\'active_char_ids\', \'' + _key + '\')'" /><span style="color: #ff99cc;">ğŸ”’ _key</span></label></div><</capture>><</for>><<for _key range Object.keys($custom_chars)>><<capture _key>><div style="margin-bottom: 2px; display:flex; align-items:center; justify-content:space-between;"><label><input type="checkbox" @checked="$active_char_ids.includes(_key)" @onchange="'toggleLibItem(\'active_char_ids\', \'' + _key + '\')'" /><span style="color: #66ccff;">ğŸ’¾ _key</span></label><a class="delete-btn" @onclick="'deleteLibItem(\'char\', \'' + _key + '\')'">ğŸ—‘ï¸</a></div><</capture>><</for>></div></div>
<</widget>>

<<widget "lib_content_lore">>
    /* ... (ä¿æŒä¸Šæ¬¡çš„å…§å®¹) ... */
     <div style="font-size: 0.9em;"><b>ğŸ“¥ åŒ¯å…¥ä¸–ç•Œ:</b><br><input type="file" onchange="loadTavernFile(this, 'lore')" style="width: 100%; font-size: 0.8em;"><hr style="margin: 5px 0; border-color: #444;"><b>ğŸ“‹ å•Ÿç”¨åˆ—è¡¨:</b><div style="max-height: 150px; overflow-y: auto; text-align: left;"><<for _key range Object.keys(setup.lore)>><<capture _key>><div style="margin-bottom: 2px;"><label><input type="checkbox" @checked="$active_world_ids.includes(_key)" @onchange="'toggleLibItem(\'active_world_ids\', \'' + _key + '\')'" /><span style="color: #ff99cc;">ğŸ”’ _key</span></label></div><</capture>><</for>><<for _key range Object.keys($custom_lore)>><<capture _key>><div style="margin-bottom: 2px; display:flex; align-items:center; justify-content:space-between;"><label><input type="checkbox" @checked="$active_world_ids.includes(_key)" @onchange="'toggleLibItem(\'active_world_ids\', \'' + _key + '\')'" /><span style="color: #66ccff;">ğŸ’¾ _key</span></label><a class="delete-btn" @onclick="'deleteLibItem(\'lore\', \'' + _key + '\')'">ğŸ—‘ï¸</a></div><</capture>><</for>></div></div>
<</widget>>