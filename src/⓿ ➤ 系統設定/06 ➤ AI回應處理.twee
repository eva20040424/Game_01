:: Action_Handler

<div id="ai-status" style="text-align:center; padding: 20px; color: cyan; border: 1px dashed #444; margin: 10px;">
    æ­£åœ¨å‘¼å« Google å¤§è…¦... <br>
    <span class="spinner">ğŸ’«</span> ä½¿ç”¨æ¨¡å‹ï¼š<<print $aiModel>>
</div>

<div id="ai-content"></div>
<div id="ai-debug" style="display:none; color: red; background: #220000; padding: 10px; border: 1px solid red; margin-top: 20px;"></div>

/* --- å›ç¨‹é–˜é–€ --- */
<<if $returnPassage>>
    <div style="margin-top: 30px; text-align: center; border-top: 1px solid #555; padding-top: 10px;">
        <<link "ğŸšª çµæŸäº’å‹•ä¸¦è¿”å›">>
            /* é›¢é–‹æ™‚ï¼Œæ¸…ç©ºç•¶å‰è§’è‰²å¡ï¼Œé¿å…å¸¶åˆ°ä¸‹ä¸€å€‹å ´æ™¯ */
            <<set $active_char_id to null>>
            <<goto $returnPassage>>
            <<set $returnPassage to null>>
        <</link>>
    </div>
<</if>>

<<script>>
    var apiKey = State.variables.apiKey;
    var model = State.variables.aiModel || "gemini-3-flash-preview";

    if (!apiKey || apiKey === "") {
        $("#ai-status").html("âŒ éŒ¯èª¤ï¼šå°šæœªè¼¸å…¥ API Keyï¼è«‹è¿”å›ã€åˆå§‹è¨­å®šã€‘é é¢å¡«å¯«ã€‚");
    } else {
        var url = "https://generativelanguage.googleapis.com/v1beta/models/" + model + ":generateContent?key=" + apiKey;

        /* === 1. çµ„åˆæç¤ºè©ç©æœ¨ === */
        
        // A. ç³»çµ±åŸºç¤æŒ‡ä»¤
        var basePrompt = setup.ai_prompt; 
        
        // B. è®€å–ç•¶å‰å•Ÿç”¨çš„ã€Œä¸–ç•Œæ›¸ã€ (é è¨­ä½¿ç”¨ 'é€šç”¨è¦å‰‡'ï¼Œé™¤éæœ‰æŒ‡å®š)
        var activeWorldId = State.variables.active_world_id || "é€šç”¨è¦å‰‡";
        var worldInfo = setup.lore[activeWorldId] ? "[WORLD SETTING]:\n" + setup.lore[activeWorldId] : "";

        // C. è®€å–ç•¶å‰å•Ÿç”¨çš„ã€Œè§’è‰²å¡ã€
        var activeCharId = State.variables.active_char_id;
        var charInfo = "";
        if (activeCharId && setup.chars[activeCharId]) {
            charInfo = "[CHARACTER CARD]:\n" + setup.chars[activeCharId];
        }

        // D. å…¶ä»–å‹•æ…‹è³‡è¨Š
        var userSystemSetting = State.variables.systemPrompt || "";
        var lastContext = State.variables.ai_last_narrative || "ï¼ˆæ•…äº‹é–‹å§‹ï¼‰";
        var playerAction = State.variables.player_act || "ç©å®¶é€²å…¥äº†å ´æ™¯";
        
        // E. æœ€çµ‚åˆé«”ï¼
        // é †åºï¼šç³»çµ±æŒ‡ä»¤ -> ä¸–ç•Œè§€ -> è§’è‰²å¡ -> ä¸Šä¸‹æ–‡ -> ç©å®¶å‹•ä½œ
        var finalPrompt = basePrompt + "\n\n" + 
                          worldInfo + "\n\n" + 
                          charInfo + "\n\n" + 
                          "[User Extra Settings]: " + userSystemSetting + "\n\n" + 
                          "ã€Current Story Contextã€‘: " + lastContext + "\n\n" + 
                          "ã€Player Current Actionã€‘: " + playerAction;

        /* === 2. ç™¼é€è«‹æ±‚ === */
        fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: finalPrompt }] }] })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error.message); });
            }
            return response.json();
        })
        .then(data => {
            try {
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error("AI æ‹’çµ•ç”Ÿæˆå…§å®¹ã€‚");
                }

                var ai_text = data.candidates[0].content.parts[0].text;
                State.variables.temp_ai_response = ai_text;

                $("#ai-status").html("âœ… æ¥æ”¶æˆåŠŸï¼Œæ­£åœ¨æ¸²æŸ“...");
                $("#ai-status").fadeOut(500); 

                var contentBox = document.getElementById("ai-content");
                new Wikifier(contentBox, "<<parse_ai_data $temp_ai_response>>");
                
            } catch (e) {
                console.error(e);
                $("#ai-status").html("âš ï¸ è§£æéŒ¯èª¤");
                $("#ai-debug").show().html("<b>ç¨‹å¼é‹ä½œéŒ¯èª¤ï¼š</b><br>" + e.message);
            }
        })
        .catch(error => {
            console.error("Error:", error);
            $("#ai-status").html("âŒ é€£ç·šéŒ¯èª¤");
            $("#ai-debug").show().html("<b>é€£ç·šå¤±æ•—åŸå› ï¼š</b><br>" + error.message);
        });
    }
<</script>>