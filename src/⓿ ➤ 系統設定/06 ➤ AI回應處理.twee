:: Action_Handler

/* ç‹€æ…‹é¡¯ç¤ºå€ */
<div id="ai-status" style="text-align:center; padding: 20px; color: cyan; border: 1px dashed #444; margin: 10px;">
    æ­£åœ¨å‘¼å« Google å¤§è…¦... <br>
    <span class="spinner">ğŸ’«</span> ä½¿ç”¨æ¨¡å‹ï¼š<<print $aiModel>>
</div>

/* å…§å®¹é¡¯ç¤ºå€ï¼šAI çš„æ•…äº‹æœƒå‡ºç¾åœ¨é€™è£¡ */
<div id="ai-content"></div>

/* éŒ¯èª¤æ—¥èªŒå€ */
<div id="ai-debug" style="display:none; color: red; background: #220000; padding: 10px; border: 1px solid red; margin-top: 20px;"></div>

/* --- ã€æ–°å¢ã€‘å›ç¨‹é–˜é–€ --- */
/* å¦‚æœç™¼ç¾æœ‰ $returnPassage (å›ç¨‹ç¥¨) é€™å€‹è®Šæ•¸ï¼Œå°±é¡¯ç¤ºé›¢é–‹æŒ‰éˆ• */
<<if $returnPassage>>
    <div style="margin-top: 30px; text-align: center; border-top: 1px solid #555; padding-top: 10px;">
        /* é»æ“Šå¾Œï¼š1.å›åˆ°åŸæœ¬çš„æˆ¿é–“ 2.æŠŠç¥¨éŠ·æ¯€(è¨­ç‚º null) */
        <<link "ğŸšª çµæŸäº’å‹•ä¸¦è¿”å›">>
            <<goto $returnPassage>>
            <<set $returnPassage to null>>
        <</link>>
    </div>
<</if>>

<<script>>
    var apiKey = State.variables.apiKey;
    var model = State.variables.aiModel || "gemini-3-flash-preview";

    if (!apiKey || apiKey === "") {
        $("#ai-status").html("âŒ éŒ¯èª¤ï¼šå°šæœªè¼¸å…¥ API Keyï¼è«‹è¿”å›ã€åˆå§‹è¨­å®šã€‘é é¢å¡«å¯«ã€‚");
    } else {
        var url = "https://generativelanguage.googleapis.com/v1beta/models/" + model + ":generateContent?key=" + apiKey;

        var basePrompt = setup.ai_prompt; 
        var userSystemSetting = State.variables.systemPrompt || "";
        var lastContext = State.variables.ai_last_narrative || "ï¼ˆæ•…äº‹é–‹å§‹ï¼‰";
        var playerAction = State.variables.player_act || "ç©å®¶é€²å…¥äº†å ´æ™¯";
        
        var finalPrompt = basePrompt + "\n" + 
                          "[User Extra Settings]: " + userSystemSetting + "\n\n" + 
                          "ã€Current Story Contextã€‘: " + lastContext + "\n\n" + 
                          "ã€Player Current Actionã€‘: " + playerAction;

        fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: finalPrompt }] }] })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error.message); });
            }
            return response.json();
        })
        .then(data => {
            try {
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error("AI æ‹’çµ•ç”Ÿæˆå…§å®¹ã€‚");
                }

                var ai_text = data.candidates[0].content.parts[0].text;
                State.variables.temp_ai_response = ai_text;

                $("#ai-status").html("âœ… æ¥æ”¶æˆåŠŸï¼Œæ­£åœ¨æ¸²æŸ“...");
                $("#ai-status").fadeOut(500); 

                var contentBox = document.getElementById("ai-content");
                new Wikifier(contentBox, "<<parse_ai_data $temp_ai_response>>");
                
            } catch (e) {
                console.error(e);
                $("#ai-status").html("âš ï¸ è§£æéŒ¯èª¤");
                $("#ai-debug").show().html("<b>ç¨‹å¼é‹ä½œéŒ¯èª¤ï¼š</b><br>" + e.message);
            }
        })
        .catch(error => {
            console.error("Error:", error);
            $("#ai-status").html("âŒ é€£ç·šéŒ¯èª¤");
            $("#ai-debug").show().html("<b>é€£ç·šå¤±æ•—åŸå› ï¼š</b><br>" + error.message);
        });
    }
<</script>>