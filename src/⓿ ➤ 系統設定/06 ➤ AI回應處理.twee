:: Action_Handler

<div id="ai-status" style="text-align:center; padding: 20px; color: cyan; border: 1px dashed #444; margin: 10px;">
    AIç”Ÿæˆä¸­... <br>
    <span class="spinner">ğŸ’«</span> ä½¿ç”¨æ¨¡å‹ï¼š<<print $aiModel>>
</div>

<div id="ai-content"></div>
<div id="ai-debug" style="display:none; color: red; background: #220000; padding: 10px; border: 1px solid red; margin-top: 20px;"></div>

/* --- å›ç¨‹é–˜é–€ --- */
<<if $returnPassage>>
    <div style="margin-top: 30px; text-align: center; border-top: 1px solid #555; padding-top: 10px;">
        <<link "ğŸšª çµæŸäº’å‹•ä¸¦è¿”å›">>
            /* é›¢é–‹æ™‚ï¼Œæ¸…ç©ºç•¶å‰è§’è‰²å¡ï¼Œé¿å…å¸¶åˆ°ä¸‹ä¸€å€‹å ´æ™¯ */
            <<set $active_char_id to null>>
            <<goto $returnPassage>>
            <<set $returnPassage to null>>
        <</link>>
    </div>
<</if>>

<<script>>
    var apiKey = State.variables.apiKey;
    var model = State.variables.aiModel || "gemini-3-flash-preview";

    if (!apiKey || apiKey === "") {
        $("#ai-status").html("âŒ éŒ¯èª¤ï¼šå°šæœªè¼¸å…¥ API Keyï¼è«‹è¿”å›ã€åˆå§‹è¨­å®šã€‘é é¢å¡«å¯«ã€‚");
    } else {
        var url = "https://generativelanguage.googleapis.com/v1beta/models/" + model + ":generateContent?key=" + apiKey;

       /* === 1. çµ„åˆæç¤ºè©ç©æœ¨ === */
        
        // A. ç³»çµ±åŸºç¤æŒ‡ä»¤ (Style / System Prompt)
        var basePrompt = "";
        var currentPresetId = State.variables.active_preset_id; 
        var presetObj = State.variables.custom_presets[currentPresetId];

        if (!presetObj || currentPresetId === "ç³»çµ±åŸå» ") {
            // æƒ…æ³ 1ï¼šä½¿ç”¨ç³»çµ±åŸå» 
            basePrompt = setup.ai_prompt;
        } else if (presetObj.type === 'simple') {
            // æƒ…æ³ 2ï¼šä½¿ç”¨èˆŠç‰ˆç°¡å–®é è¨­ (åªæœ‰ä¸€æ®µå­—)
            basePrompt = presetObj.data;
        } else if (presetObj.type === 'advanced') {
            // æƒ…æ³ 3ï¼šâœ¨ ä½¿ç”¨é…’é¤¨è¤‡é›œé è¨­ (ç©æœ¨çµ„åˆ) âœ¨
            // éæ­·æ‰€æœ‰æ¨¡çµ„ï¼ŒåªæŠŠ enabled = true çš„æ‹¼èµ·ä¾†
            var promptParts = [];
            presetObj.data.forEach(function(block) {
                if (block.enabled) {
                    promptParts.push(block.content);
                }
            });
            basePrompt = promptParts.join("\n\n");
        }
        
        console.log("ğŸ”¥ Prompt çµ„åˆå®Œæˆï¼Œä¾†æºï¼š", currentPresetId);

        // B. ä¸–ç•Œè§€ (Lore)
        var worldIds = [];
        if (State.variables.active_world_ids) worldIds = worldIds.concat(State.variables.active_world_ids);
        if (State.variables.active_world_id) worldIds.push(State.variables.active_world_id);
        if (worldIds.length === 0) worldIds.push("é€šç”¨è¦å‰‡");

        var worldInfo = "";
        [...new Set(worldIds)].forEach(function(id) {
            var content = State.variables.custom_lore[id] || setup.lore[id];
            if (content) worldInfo += "### [WORLD SETTING - " + id + "]:\n" + content + "\n\n";
        });

        // C. è§’è‰²æ›¸ (Character) - åˆ†é›¢ NPC èˆ‡ ä¸»è§’
        var charIds = [];
        if (State.variables.active_char_ids) charIds = charIds.concat(State.variables.active_char_ids);
        if (State.variables.active_char_id) charIds.push(State.variables.active_char_id);

        var npcInfo = "";
        var playerInfo = "";
        var playerName = State.variables.name;

        [...new Set(charIds)].forEach(function(id) {
            var content = State.variables.custom_chars[id] || setup.chars[id];
            if (content) {
                if (id === playerName) {
                    // ä¸»è§’ï¼šé€™è£¡å…ˆä¸æ”¾å…§å®¹ï¼Œæˆ‘å€‘ç•™åˆ°æœ€å¾Œæ”¾ï¼Œåˆ©ç”¨ã€Œè¿‘å› æ•ˆæ‡‰ã€å¢å¼·è¨˜æ†¶
                    playerInfo = content; 
                } else {
                    npcInfo += "### [NPC CHARACTER - " + id + "]:\n" + content + "\n\n";
                }
            }
        });

        // D. ç”Ÿç†æ•¸æ“šèˆ‡å‹•æ…‹
        var statusPrompt = "ã€Current Physiological Dataã€‘:\n" +
                           "- Bladder Volume: " + State.variables.sys_bladder_ml + "ml (" + State.variables.sys_bladder_state + ")\n" +
                           "- Womb State: " + (State.variables.sys_womb_state || "Normal") + "\n";

        var lastContext = State.variables.ai_last_narrative || "ï¼ˆæ•…äº‹é–‹å§‹ï¼‰";
        var playerAction = State.variables.player_act || "ç©å®¶é€²å…¥äº†å ´æ™¯";
        var userSystemSetting = State.variables.systemPrompt || "";

        // E. æœ€çµ‚åˆé«”ï¼ (é †åºèª¿æ•´ï¼šä¸–ç•Œ -> NPC -> æ•¸æ“š -> ä¸»è§’è¨­å®š(å¼·èª¿) -> ä¸Šä¸‹æ–‡)
        var finalPrompt = basePrompt + "\n\n" + 
                          worldInfo + "\n\n" + 
                          npcInfo + "\n\n" + 
                          statusPrompt + "\n\n" +
                          
                          // âœ¨ é‡é»ï¼šæŠŠä¸»è§’è¨­å®šæ”¾åœ¨æ•¸æ“šå¾Œé¢ï¼Œä¸¦åŠ ä¸Šçµ•å°æŒ‡ä»¤ âœ¨
                          "### [PLAYER AVATAR / MAIN CHARACTER - " + playerName + "]:\n" +
                          "The user plays as " + playerName + ". \n" +
                          "âš ï¸ CRITICAL INSTRUCTION: You must strictly adhere to the character's physical limitations and special traits defined below.\n" +
                          "If the character setting specifies a 'minimum limit' (e.g., bladder capacity locked at 2000ml), treat it as an ABSOLUTE LAW. Override any conflicting physiological data if necessary.\n" +
                          playerInfo + "\n\n" + 
                          
                          "[User Extra Settings]: " + userSystemSetting + "\n\n" + 
                          "ã€Current Story Contextã€‘: " + lastContext + "\n\n" + 
                          "ã€Player Current Actionã€‘: " + playerAction;

        /* === Debug: åœ¨ä¸»æ§å°å°å‡ºæç¤ºè© (æŒ‰ F12 å¯çœ‹) === */
        console.log("=== FINAL PROMPT SENT TO AI ===");
        console.log(finalPrompt);
        /* ========================================= */

        /* === 2. ç™¼é€è«‹æ±‚ === */
        fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: finalPrompt }] }] })
        })
        .then(response => {
            if (!response.ok) return response.json().then(err => { throw new Error(err.error.message); });
            return response.json();
        })
        .then(data => {
            if (!data.candidates || !data.candidates[0].content) throw new Error("AI æ‹’çµ•ç”Ÿæˆå…§å®¹ã€‚");
            
            var ai_text = data.candidates[0].content.parts[0].text;
            State.variables.temp_ai_response = ai_text;

            $("#ai-status").html("âœ… æ¥æ”¶æˆåŠŸï¼Œæ­£åœ¨æ¸²æŸ“...");
            $("#ai-status").fadeOut(500); 

            var contentBox = document.getElementById("ai-content");
            new Wikifier(contentBox, "<<parse_ai_data $temp_ai_response>>");
        })
        .catch(error => {
            console.error(e);
            $("#ai-status").html("âŒ é€£ç·šéŒ¯èª¤");
            $("#ai-debug").show().html("<b>é€£ç·šå¤±æ•—åŸå› ï¼š</b><br>" + error.message);
        });
    }
<</script>>