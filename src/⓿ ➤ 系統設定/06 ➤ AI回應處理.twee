:: Action_Handler

/* ç‹€æ…‹é¡¯ç¤ºå€ */
<div id="ai-status" style="text-align:center; padding: 20px; color: cyan; border: 1px dashed #444; margin: 10px;">
    æ­£åœ¨å‘¼å« Google å¤§è…¦... <br>
    <span class="spinner">ğŸ’«</span> ä½¿ç”¨æ¨¡å‹ï¼š<<print $aiModel>>
</div>

/* å…§å®¹é¡¯ç¤ºå€ï¼šAI çš„æ•…äº‹æœƒå‡ºç¾åœ¨é€™è£¡ */
<div id="ai-content"></div>

/* éŒ¯èª¤æ—¥èªŒå€ */
<div id="ai-debug" style="display:none; color: red; background: #220000; padding: 10px; border: 1px solid red; margin-top: 20px;"></div>

<<script>>
    // 1. è¨­å®šåƒæ•¸
    var apiKey = State.variables.apiKey;
    var model = State.variables.aiModel || "gemini-3-flash-preview";

    // æª¢æŸ¥ Key
    if (!apiKey || apiKey === "") {
        $("#ai-status").html("âŒ éŒ¯èª¤ï¼šå°šæœªè¼¸å…¥ API Keyï¼è«‹è¿”å›ã€åˆå§‹è¨­å®šã€‘é é¢å¡«å¯«ã€‚");
    } else {

        // 2. æº–å‚™ç¶²å€
        var url = "https://generativelanguage.googleapis.com/v1beta/models/" + model + ":generateContent?key=" + apiKey;

        // 3. æº–å‚™æç¤ºè©
        var basePrompt = setup.ai_prompt; 
        var userSystemSetting = State.variables.systemPrompt || "";
        var lastContext = State.variables.ai_last_narrative || "ï¼ˆæ•…äº‹é–‹å§‹ï¼‰";
        var playerAction = State.variables.player_act || "ç©å®¶é€²å…¥äº†å ´æ™¯";
        
        var finalPrompt = basePrompt + "\n" + 
                          "[User Extra Settings]: " + userSystemSetting + "\n\n" + 
                          "ã€Current Story Contextã€‘: " + lastContext + "\n\n" + 
                          "ã€Player Current Actionã€‘: " + playerAction;

        // 4. ç™¼é€è«‹æ±‚
        fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: finalPrompt }] }] })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error.message); });
            }
            return response.json();
        })
        .then(data => {
            // 5. æ¥æ”¶è³‡æ–™è™•ç†
            try {
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error("AI æ‹’çµ•ç”Ÿæˆå…§å®¹ï¼ˆå¯èƒ½æ˜¯å®‰å…¨éæ¿¾æˆ–ç„¡å…§å®¹ï¼‰ã€‚");
                }

                var ai_text = data.candidates[0].content.parts[0].text;
                
                // å­˜å…¥è‡¨æ™‚è®Šæ•¸
                State.variables.temp_ai_response = ai_text;

                // æ›´æ–°ç‹€æ…‹
                $("#ai-status").html("âœ… æ¥æ”¶æˆåŠŸï¼Œæ­£åœ¨æ¸²æŸ“...");
                $("#ai-status").fadeOut(500); 

                // ã€é—œéµä¿®å¾©é»ã€‘ï¼šä½¿ç”¨ document.getElementById æŠ“å–çœŸæ­£çš„ç¶²é å…ƒç´ 
                var contentBox = document.getElementById("ai-content");
                new Wikifier(contentBox, "<<parse_ai_data $temp_ai_response>>");
                
            } catch (e) {
                console.error(e);
                $("#ai-status").html("âš ï¸ è§£æéŒ¯èª¤");
                $("#ai-debug").show().html("<b>ç¨‹å¼é‹ä½œéŒ¯èª¤ï¼š</b><br>" + e.message + "<br><br><b>åŸå§‹å›å‚³è³‡æ–™ï¼š</b><br>" + JSON.stringify(data));
            }
        })
        .catch(error => {
            console.error("Error:", error);
            $("#ai-status").html("âŒ é€£ç·šéŒ¯èª¤");
            $("#ai-debug").show().html("<b>é€£ç·šå¤±æ•—åŸå› ï¼š</b><br>" + error.message);
        });
    }
<</script>>